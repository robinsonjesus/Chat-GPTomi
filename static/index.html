<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My GPT Chat</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      display: flex;
      height: 100vh;
    }

    /* Sidebar */
    #sidebar {
      width: 220px;
      background-color: #f0f0f0;
      padding: 10px;
      border-right: 1px solid #ccc;
      box-sizing: border-box;
      overflow-y: auto;
    }

    #sidebar h2 {
      font-size: 18px;
      margin-top: 0;
    }

    #newChatBtn {
      margin-bottom: 10px;
      width: 100%;
      padding: 8px;
      font-size: 14px;
      cursor: pointer;
    }

    .session-item {
      padding: 8px;
      margin-bottom: 5px;
      background: #fff;
      cursor: pointer;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }

    .session-item:hover {
      background-color: #e0e0e0;
    }

    /* Main content */
    #main {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      box-sizing: border-box;
    }

    #chat {
      border: 1px solid #ccc;
      padding: 15px;
      height: 100%;
      overflow-y: auto;
      background-color: #f9f9f9;
      flex-grow: 1;
      margin-bottom: 10px;
    }

    .message {
      margin-bottom: 10px;
    }

    .user {
      font-weight: bold;
      color: #0077cc;
    }

    .assistant {
      color: #333;
    }

    input[type="text"] {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      box-sizing: border-box;
    }
  </style>
</head>
<body>

  <!-- Sidebar: session list -->
  <div id="sidebar">
    <h2>Chats</h2>
    <button id="newChatBtn">+ New Chat</button>
    <div id="sessionList"></div>
  </div>

  <!-- Main chat area -->
  <div id="main">
    <div id="chat"></div>
    <input
      type="text"
      id="userMessage"
      placeholder="Type your message and press Enter..."
      onkeydown="handleKey(event)"
    />
    <input type="hidden" id="sessionId" value="" />
  </div>

  <script>
    // Handle Enter key to send message
    function handleKey(event) {
      if (event.key === "Enter") {
        sendMessage();
      }
    }

    // Display a single message (either user or assistant) in the chat window
    function displayMessage(role, content) {
      const chatBox = document.getElementById("chat");
      const className = role === "user" ? "user" : "assistant";
      const name = role === "user" ? "You" : "Assistant";
      chatBox.innerHTML += `<div class="message"><span class="${className}">${name}:</span> ${content}</div>`;
      chatBox.scrollTop = chatBox.scrollHeight; // Automatically scroll to the bottom of the chat
    }

    // Clear the chat window
    function clearChat() {
      document.getElementById("chat").innerHTML = ""; // Empty the chat content
    }

    // Load all messages for a specific session
    function loadSession(sessionId) {
      fetch(`/session/${sessionId}`)
        .then(res => res.json())
        .then(messages => {
          document.getElementById("sessionId").value = sessionId; // Store sessionId in hidden input
          clearChat(); // Clear the chat before loading the messages
          messages.forEach(msg => displayMessage(msg.role, msg.content)); // Display each message in the session
        });
    }

    // Load all session IDs and display them in the sidebar
    function loadSessionList() {
  fetch("/sessions")
    .then(res => res.json())
    .then(sessions => {
      const list = document.getElementById("sessionList");
      list.innerHTML = ""; // Clear the session list

      sessions.forEach(session => {
        const item = document.createElement("div");
        item.className = "session-item";
        item.textContent = session;

        // âœ… Highlight currently selected session
        if (session === document.getElementById("sessionId").value) {
          item.style.backgroundColor = "#d0e6ff";
        }

        item.onclick = () => {
          loadSession(session);
        };

        list.appendChild(item);
      });

      // âœ… Only auto-load a session if none is currently selected
      const current = document.getElementById("sessionId").value;
      if (!current && sessions.length > 0) {
        loadSession(sessions[0]); // Only auto-load if not already in a session
      }
    });
}


    // Send a message to the backend and display the assistant's response
    function sendMessage() {
      const messageInput = document.getElementById("userMessage");
      const sessionId = document.getElementById("sessionId").value; // Get the current sessionId
      const message = messageInput.value.trim(); // Trim leading/trailing spaces

      if (message === "") return; // Don't send empty messages

      displayMessage("user", message); // Display the user's message

      // Send the message to the backend
      fetch("/chat", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          prompt: message,
          session_id: sessionId // Include the sessionId in the request
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.response) {
          displayMessage("assistant", data.response); // Display the assistant's response
          messageInput.value = ""; // Clear the input field after sending the message
          if (data.session_id) {
            document.getElementById("sessionId").value = data.session_id; // Update the sessionId if changed
            loadSessionList(); // Refresh the session list with the updated session
          }
        }
      });
    }

    // âœ… Send a POST request to backend to create a new empty session
  async function createNewSession() {
    const newId = new Date().toISOString().replace(/[-:.TZ]/g, "_"); // Create unique session ID
    document.getElementById("sessionId").value = newId; // Set session ID in hidden input
    clearChat(); // Clear the chat window

    // âœ… Tell the backend to create a new session file
    try {
      const res = await fetch("/session/new", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ session_id: newId })
      });

      const data = await res.json();
      if (!res.ok) {
        console.error("Error creating session:", data);
      } else {
        console.log("New session created:", data.session_id);
        loadSessionList(); // Refresh list to include new session
      }
    } catch (err) {
      console.error("Fetch error creating new session:", err);
    }
  }

  // âœ… Listen for new chat button WITHOUT refreshing the page
  document.getElementById("newChatBtn").addEventListener("click", (e) => {
    e.preventDefault(); // ðŸ›‘ Stop default form behavior (page reload)
    createNewSession();
  });

  window.onload = loadSessionList; // Initial load of sessions
  </script>

</body>
</html>
